# <strong> GraphTracking </strong>

Master thesis of Leonardo Saraceni at Sapienza University of Rome in collaboration with Canopies Project.

* Tracking algorithm which exploits:
    * detection information (images and bounding boxes)
    * 3D information from Structure from Motion (SfM) using COLMAP
* Pseudo-labels generation for semi-supervised learning pipeline levaraging:
    * SURF feature extractor (provided by OpenCV)
    * 3D information from Structure from Motion (SfM) using COLMAP

The <strong> paper </strong> can be obtained to the following link:
https://openaccess.thecvf.com/content/CVPR2022W/AgriVision/html/Ciarfuglia_Pseudo-Label_Generation_for_Agricultural_Robotics_Applications_CVPRW_2022_paper.html

## <strong> Installation: </strong>

* ### <strong> Python dependencies: </strong>
    To test the tool is necessary to clone this repository and to install the requirements with the python dependencies:
    ```
    pip3 install -r requirements.txt
    ```

* ### <strong> OpenCV: </strong>
    It is necessary to install OpenCV from source to enable the NON-FREE algorithm (like the SURF features extractor). Refer to the follwing link for the instructions:
    https://docs.opencv.org/3.4/d7/d9f/tutorial_linux_install.html

    What worked for me (but may not work for you) was to compile using the following CMAKE flags:
    ```
    cmake -D CMAKE_BUILD_TYPE=RELEASE
        -D CMAKE_INSTALL_PREFIX=/usr/local
        -D INSTALL_C_EXAMPLES=ON
        -D INSTALL_PYTHON_EXAMPLES=ON
        -D OPENCV_GENERATE_PKGCONFIG=ON
        -D OPENCV_ENABLE_NONFREE=ON
        -D OPENCV_EXTRA_MODULES_PATH=~/opencv_build/opencv_contrib/modules
        -D BUILD_EXAMPLES=ON
        -D PYTHON3_PACKAGES_PATH=/usr/lib/python3/dist-packages ..
    ```

* ### <strong> COLMAP: </strong>
    Refer to the following link for the installation of COLMAP:
    https://colmap.github.io/install.html

## <strong>Demo</strong>:

We provide some small demo to generate pseudo-labels from the features extracted by SURF or from the SfM algorithm (COLMAP), together with a demo of the tracker. The images together with the detection labels extracted using YOLOv5 are saved in the <em>./Datasets/dataset_name/Detection</em> folder, while the 3D models are in the <em>./Datasets/dataset_name/ModelText</em> folder. We provide a total of 3 datasets to test the demo, in order to run the tracker demo use the command:

```
python3 Bboxes_Tracker.py
```

To run the pseudo-labels generation demo using the features extracted by SURF use the command:

```
python3 Generate_Features_Labels.py
```

To run the pseudo-labels generation demo leveraging the Structure from Motion (SfM) information use:
```
python3 Generate_SfM_Labels.py
```


## <strong>Scripts</strong>:
* ### <strong>Bboxes_Tracker:</strong> 
    Tracking algorithm for grape instances, requires a COLMAP model of the scene and the predictions obtained by a detector (YOLO in the case of this project). Need to modify the configuration file in Config/config_track.yaml with the paths required by your project.
    ```
    python3 Bboxes_Tracker.py
    ```
* ### <strong>Generate_Features_Labels:</strong>
    Algorithm to generate the pseudo labels to finetune the detector on the target set, using the features extracted using SURF. It requires the prediction of the detector to finetune (YOLO in the case of this project), and to have installed OpenCV by compiling him to support also the non-free features.
    Is necessary to modify the configuration file in Config/config_labels.yaml with the paths required by your project.
    ```
    python3 Generate_Features_Labels.py
    ```
* ### <strong>Generate_SfM_Labels:</strong> 
    Algorithm to generate the pseudo labels to finetune the detector on the target set. It requires the prediction of the detector to finetune (YOLO in the case of this project) and a 3-D model (txt model) of the environment generated by COLMAP, a SfM framework that given a sequence of frames returns the 3D reconstruction of the environment.
    Is necessary to modify the configuration file in Config/config_sfm_labels.yaml with the paths required by your project.
    ```
    python3 Generate_SfM_Labels.py
    ```
